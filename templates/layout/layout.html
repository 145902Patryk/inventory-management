{% extends 'base.html' %}
{% load static %}
{% block extra_css %}
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/izitoast/1.4.0/css/iziToast.min.css"/>
  <link rel="stylesheet" href="{% static 'css/layout.min.css' %}">
{% endblock extra_css %}
{% block content %}
  <div class="container">
    <div class="row">
      {% for layout in object_list %}
        <div class="col-md-8">
          <div id="imagePreview{{ layout.pk }}" class="img-div">
            <img src="{{ layout.image.url }}">
          </div>
        </div>
        <div class="col-md-4">
          <ul class="list-group">
            <li class="list-group-item"><h2>{{ layout.name }}</h2></li>

            {% for x in layout.location_set.all %}
              <li class="list-group-item list-group-item-primary">{{ x.name }}</li>
            {% endfor %}
          </ul>
        </div>
      {% endfor %}
    </div>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="modalForm" tabindex="-1" role="dialog" aria-labelledby="modalFormTitle"
       aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add location</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form id="locationForm" action="{% url 'layout:add_location' %}" method="POST">
            {% csrf_token %}
            {{ form.as_p }}
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" onclick="addLocation()">Save</button>
        </div>
      </div>
    </div>
  </div>
{% endblock content %}
{% block extra_js %}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/izitoast/1.4.0/js/iziToast.min.js"></script>
  <script>
      const dots = Object({{ js_obj|safe }});
      const images = $('.img-div img');
      const addLocation = () => {
          $.ajax({
              url: '{% url 'layout:add_location' %}',
              type: 'POST',
              data: $('#locationForm').serialize(),
              success: (data) => {
                  const imgDiv = $('#imagePreview' + data.layout)
                  const dot = $('<div />', {
                      'class': 'dot',
                      css: {
                          top: `${data.y}%`,
                          left: `${data.x}%`,
                          width: 20,
                          height: 20,
                      },
                  });
                  imgDiv.append(dot)
                  dot.data({name: data.name, pk: data.pk})
                  $('#modalForm').modal('hide')
              },
              error: (e) => {
                  iziToast.error({
                      title: 'Form error',
                      message: e.responseText,
                      timeout: 8000,
                  })
              }
          })
      }
      $('#modalForm').on('hidden.bs.modal', () => {
          $('.dot-placeholder').remove()
      })
      images.on('dragstart', (event) => {
          event.preventDefault();
      });
      images.on('click', (ev) => {
          const img = $(ev.currentTarget)
          const o = img.offset()
          const y = (ev.pageY - o.top) / img.height() * 100
          const x = (ev.pageX - o.left) / img.width() * 100
          const dot = $('<div />', {
              'class': 'dot-placeholder',
              css: {
                  top: `${y}%`,
                  left: `${x}%`,
                  width: 20,
                  height: 20,
              },
          });
          const imagePreview = img.parent()
          const pk = imagePreview.attr('id').replace('imagePreview', '')
          imagePreview.append(dot)
          $('#id_x').attr('value', x)
          $('#id_y').attr('value', y)
          $('#id_layout').val(pk).change()
          $('#modalForm').modal('show')
      });
      $(document).ready(() => {
          for (const [key, value] of Object.entries(dots)) {
              const imgDiv = $('#' + key)
              value.forEach((el) => {
                  const dot = $('<div />', {
                      'class': 'dot',
                      css: {
                          top: `${el.y}%`,
                          left: `${el.x}%`,
                          width: 20,
                          height: 20,
                      },
                  });
                  imgDiv.append(dot)
                  dot.data({name: el.name, pk: el.pk})
              })
          }
      })
      $(document).on('click', '.dot', (ev) => {
          const dot = $(ev.currentTarget)
          console.log(dot.data())
      })
  </script>
{% endblock extra_js %}